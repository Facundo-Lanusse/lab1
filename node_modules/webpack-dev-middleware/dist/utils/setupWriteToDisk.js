"use strict";

const fs = require("fs");
<<<<<<< HEAD

const path = require("path");
/** @typedef {import("webpack").Compiler} Compiler */

/** @typedef {import("webpack").MultiCompiler} MultiCompiler */

/** @typedef {import("webpack").Compilation} Compilation */

/** @typedef {import("../index.js").IncomingMessage} IncomingMessage */

=======
const path = require("path");

/** @typedef {import("webpack").Compiler} Compiler */
/** @typedef {import("webpack").MultiCompiler} MultiCompiler */
/** @typedef {import("webpack").Compilation} Compilation */
/** @typedef {import("../index.js").IncomingMessage} IncomingMessage */
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
/** @typedef {import("../index.js").ServerResponse} ServerResponse */

/**
 * @template {IncomingMessage} Request
 * @template {ServerResponse} Response
<<<<<<< HEAD
 * @param {import("../index.js").Context<Request, Response>} context
 */


=======
 * @param {import("../index.js").WithOptional<import("../index.js").Context<Request, Response>, "watching" | "outputFileSystem">} context
 */
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
function setupWriteToDisk(context) {
  /**
   * @type {Compiler[]}
   */
<<<<<<< HEAD
  const compilers =
  /** @type {MultiCompiler} */
  context.compiler.compilers || [context.compiler];

  for (const compiler of compilers) {
    compiler.hooks.emit.tap("DevMiddleware",
    /**
     * @param {Compilation} compilation
     */
    compilation => {
=======
  const compilers = /** @type {MultiCompiler} */
  context.compiler.compilers || [context.compiler];
  for (const compiler of compilers) {
    if (compiler.options.devServer === false) {
      // eslint-disable-next-line no-continue
      continue;
    }
    compiler.hooks.emit.tap("DevMiddleware", () => {
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
      // @ts-ignore
      if (compiler.hasWebpackDevMiddlewareAssetEmittedCallback) {
        return;
      }
<<<<<<< HEAD

      compiler.hooks.assetEmitted.tapAsync("DevMiddleware", (file, info, callback) => {
        /**
         * @type {string}
         */
        let targetPath;
        /**
         * @type {Buffer}
         */

        let content; // webpack@5

        if (info.compilation) {
          ({
            targetPath,
            content
          } = info);
        } else {
          let targetFile = file;
          const queryStringIdx = targetFile.indexOf("?");

          if (queryStringIdx >= 0) {
            targetFile = targetFile.slice(0, queryStringIdx);
          }

          let {
            outputPath
          } = compiler;
          outputPath = compilation.getPath(outputPath, {}); // @ts-ignore

          content = info;
          targetPath = path.join(outputPath, targetFile);
        }

=======
      compiler.hooks.assetEmitted.tapAsync("DevMiddleware", (file, info, callback) => {
        const {
          targetPath,
          content
        } = info;
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
        const {
          writeToDisk: filter
        } = context.options;
        const allowWrite = filter && typeof filter === "function" ? filter(targetPath) : true;
<<<<<<< HEAD

        if (!allowWrite) {
          return callback();
        }

=======
        if (!allowWrite) {
          return callback();
        }
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
        const dir = path.dirname(targetPath);
        const name = compiler.options.name ? `Child "${compiler.options.name}": ` : "";
        return fs.mkdir(dir, {
          recursive: true
        }, mkdirError => {
          if (mkdirError) {
            context.logger.error(`${name}Unable to write "${dir}" directory to disk:\n${mkdirError}`);
            return callback(mkdirError);
          }
<<<<<<< HEAD

=======
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
          return fs.writeFile(targetPath, content, writeFileError => {
            if (writeFileError) {
              context.logger.error(`${name}Unable to write "${targetPath}" asset to disk:\n${writeFileError}`);
              return callback(writeFileError);
            }
<<<<<<< HEAD

=======
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
            context.logger.log(`${name}Asset written to disk: "${targetPath}"`);
            return callback();
          });
        });
<<<<<<< HEAD
      }); // @ts-ignore

=======
      });

      // @ts-ignore
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
      compiler.hasWebpackDevMiddlewareAssetEmittedCallback = true;
    });
  }
}
<<<<<<< HEAD

=======
>>>>>>> f7dcd41628dfb5dfbbd2d9329defc58313d35f41
module.exports = setupWriteToDisk;